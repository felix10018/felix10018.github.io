(window.webpackJsonp=window.webpackJsonp||[]).push([[133],{626:function(s,t,n){"use strict";n.r(t);var a=n(30),e=Object(a.a)({},(function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h2",{attrs:{id:"django之中间件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#django之中间件"}},[s._v("#")]),s._v(" django之中间件")]),s._v(" "),n("p",[s._v("Django的中间件（Middleware）是一个轻量级的、底层的插件系统，可以介入Django的请求和响应处理过程。它修改Django的输入或输出。每个中间件组件都负责做一些特定的功能。")]),s._v(" "),n("h3",{attrs:{id:"中间件的作用"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#中间件的作用"}},[s._v("#")]),s._v(" 中间件的作用")]),s._v(" "),n("div",{staticClass:"language-md line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-md"}},[n("code",[s._v("请求处理：在视图被调用之前，中间件可以对请求进行一些预处理。\n视图处理：中间件可以调用视图，或者修改传递给视图的参数，或者处理视图的输出。\n响应处理：在响应返回给客户端之前，中间件可以对响应进行一些后处理。\n过程处理：中间件可以决定请求是否被继续处理，或者是否立即返回响应。\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("h3",{attrs:{id:"中间件的写法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#中间件的写法"}},[s._v("#")]),s._v(" 中间件的写法")]),s._v(" "),n("p",[s._v("中间件是一个类，它必须包含以下几个方法中的一个或多个：")]),s._v(" "),n("p",[n("strong",[s._v("init")]),s._v(": 初始化中间件。\nprocess_request(self, request): 处理请求之前的操作。返回None表示继续处理请求；返回HttpResponse对象表示不继续处理请求，并返回该对象。\nprocess_view(self, request, view_func, view_args, view_kwargs): 在视图函数执行之前调用。返回None表示继续处理；返回HttpResponse对象表示不继续处理，并返回该对象。\nprocess_template_response(self, request, response): 在模板渲染之前调用。如果返回值为None，Django将继续处理这个响应对象，否则，Django将使用这个新值作为响应。\nprocess_exception(self, request, exception): 当视图函数抛出异常时调用。返回None表示继续处理；返回HttpResponse对象表示处理异常，并返回该对象。\nprocess_response(self, request, response): 在所有响应返回给客户端之前调用。必须返回HttpResponse对象。\n中间件的注册\n中间件需要在Django的settings.py文件中的MIDDLEWARE列表中注册。列表中的中间件会按照从上到下的顺序执行。")]),s._v(" "),n("h3",{attrs:{id:"示例"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#示例"}},[s._v("#")]),s._v(" 示例")]),s._v(" "),n("p",[s._v("以下是一个简单的中间件示例，它会在每个请求被处理前打印一条日志：")]),s._v(" "),n("div",{staticClass:"language-python line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-python"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" django"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("utils"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("deprecation "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" MiddlewareMixin  \n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" logging  \n  \nlogger "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" logging"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("getLogger"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("__name__"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  \n  \n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SimpleMiddleware")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("MiddlewareMixin"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  \n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("process_request")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("self"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" request"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  \n        logger"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("info"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Something is happening before the request is processed."')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  \n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 这里可以返回HttpResponse对象来短路请求/响应周期  ")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# return HttpResponse("Hello from Middleware!")')]),s._v("\n在settings"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("py中注册这个中间件：\n\npython\nMIDDLEWARE "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("  \n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ...  ")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'myapp.middleware.SimpleMiddleware'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  \n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ...  ")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br")])]),n("h3",{attrs:{id:"注意事项"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#注意事项"}},[s._v("#")]),s._v(" ----注意事项")]),s._v(" "),n("p",[s._v("中间件的执行顺序很重要，因为它决定了哪个中间件首先处理请求和响应。\n中间件不应该执行复杂的操作，以保持代码的清晰和性能。\n当中间件返回HttpResponse对象时，Django将不会调用视图函数，也不会调用之后的中间件（在返回HttpResponse的中间件之后的）。\n如果在中间件中抛出了异常，Django将会调用process_exception方法（如果定义了这个方法的话），如果这个方法也返回了HttpResponse对象，则不会将异常传递给视图。如果没有中间件处理异常，Django将会把异常传递给视图（如果视图期望处理它的话）。")]),s._v(" "),n("h3",{attrs:{id:"setting中默认可用的中间件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#setting中默认可用的中间件"}},[s._v("#")]),s._v(" setting中默认可用的中间件")]),s._v(" "),n("p",[s._v("在 Django 的默认配置中，"),n("code",[s._v("settings.py")]),s._v(" 文件中的 "),n("code",[s._v("MIDDLEWARE")]),s._v(" 列表包含了一些默认的中间件，以下是一些常见的默认中间件及其作用：")]),s._v(" "),n("ol",[n("li",[n("p",[n("code",[s._v("'django.middleware.security.SecurityMiddleware'")]),s._v("：处理与安全相关的设置，例如设置一些安全头部信息。")])]),s._v(" "),n("li",[n("p",[n("code",[s._v("'django.contrib.sessions.middleware.SessionMiddleware'")]),s._v("：启用会话支持，允许在请求之间存储和访问用户会话数据。")])]),s._v(" "),n("li",[n("p",[n("code",[s._v("'django.middleware.common.CommonMiddleware'")]),s._v("：处理一些常见的 HTTP 相关的操作，例如处理请求路径的规范化。")])]),s._v(" "),n("li",[n("p",[n("code",[s._v("'django.middleware.csrf.CsrfViewMiddleware'")]),s._v("：提供跨站请求伪造（CSRF）保护。")])]),s._v(" "),n("li",[n("p",[n("code",[s._v("'django.contrib.auth.middleware.AuthenticationMiddleware'")]),s._v("：将用户与请求关联，以便在视图中访问当前经过身份验证的用户。")])]),s._v(" "),n("li",[n("p",[n("code",[s._v("'django.contrib.messages.middleware.MessageMiddleware'")]),s._v("：处理与消息框架相关的操作，允许在视图中添加和显示消息。")])]),s._v(" "),n("li",[n("p",[n("code",[s._v("'django.middleware.clickjacking.XFrameOptionsMiddleware'")]),s._v("：用于防止点击劫持攻击。")])])]),s._v(" "),n("p",[s._v("这些默认的中间件为 Django 应用提供了基本的功能和安全保障。您可以根据项目的具体需求添加自定义的中间件或对默认中间件的行为进行配置和调整。")]),s._v(" "),n("h3",{attrs:{id:"自定义自己的中间件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#自定义自己的中间件"}},[s._v("#")]),s._v(" 自定义自己的中间件")]),s._v(" "),n("p",[s._v("1-创建一个 Python 类：")]),s._v(" "),n("div",{staticClass:"language-py line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-py"}},[n("code",[s._v("   "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" django"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("utils"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("deprecation "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" MiddlewareMixin\n\n   "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("CustomMiddleware")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("MiddlewareMixin"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n       "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("__init__")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("self"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" get_response"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n           self"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("get_response "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" get_response\n\n       "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("process_request")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("self"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" request"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n           "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在此处编写请求处理的逻辑")]),s._v("\n           "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("None")]),s._v("\n\n       "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("process_response")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("self"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" request"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" response"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n           "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在此处编写响应处理的逻辑")]),s._v("\n           "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" response\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br")])]),n("p",[s._v("2-在 process_request 方法中处理请求相关的逻辑：\n--可以访问和修改 request 对象的属性，例如请求的方法、路径、参数等。\n--根据条件决定是否继续处理请求，或者提前返回响应。")]),s._v(" "),n("p",[s._v("3--在 process_response 方法中处理响应相关的逻辑：\n可以访问和修改 response 对象的属性，例如添加响应头部、修改响应内容等。\n将自定义中间件添加到 Django 项目的 settings.py 文件中的 MIDDLEWARE 列表中：")]),s._v(" "),n("div",{staticClass:"language-py line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-py"}},[n("code",[s._v("   MIDDLEWARE "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n       "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 其他默认中间件")]),s._v("\n       "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'your_app_name.middlewares.CustomMiddleware'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n   "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("---1,中间件的方法应该返回 None 或者一个有效的 HttpResponse 对象。\n---2,如果在 process_request 中返回了一个 HttpResponse 对象，\nDjango 将不再执行后续的中间件和视图函数，直接将该响应返回给客户端。\n---3,按照中间件在 MIDDLEWARE 列表中的顺序，依次执行其处理逻辑。")])])}),[],!1,null,null,null);t.default=e.exports}}]);